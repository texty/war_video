<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Російські війська в Україні</title>

    <link rel='stylesheet' href='css/styles.css' />
</head>

<body>
   
    <header>
        
        <div>
            <img style='width:150px; margin: 10px 0 50px' src='white_logo.svg'/>
        <h1>Російські війська в Україні.<br> <span style="color:white;">Хронологія</span></h1>
    </div>
    </header>
    <main>
        
      
        <div id='video-wrapper'>
            <div>
                <span id="show_all_video">Ви бачите всі відео</span>
                <span id='selected-date'>Обреріть день в календарі: </span>                
                <div id="calendar-wrapper"></div> 
               
            </div>
        </div>      
    </main>
</body>

<script src='lib/d3v5.min.js'></script> 
<script src="lib/popper.min.js"></script>
<script src="lib/tippy-bundle.umd.js"></script>

<script>
    const ROOT = 'https://texty.org.ua/d/2022/war_video/'
	const month_list = ['січ','лют','бер','кві','тра','чер','лип','сер','вер','жов','лис','гру'];
    const month = d3.timeMonths(new Date("2021-12-31"), new Date());
    var month_data = [];
    for(var i = 0; i < month.length; i++){
        console.log(month[i].getMonth())
        month_data.push(month_list[month[i].getMonth()])
    }


    var width = 200,
        height = 136,
        cellSize = 14;

    var color = d3.scaleQuantize()
        .domain([1, 3])
        .range(['#e7d7d3','#efbcaf','#f2a18b', '#f18569', '#ed6746' ]);

    var svg = d3.select("#calendar-wrapper")
        .selectAll("svg")
        .data(d3.range(2022, 2023))
        .enter().append("svg")
        .attr("width", width)
        .attr("height", height)

    var svg_g = svg    
        .append("g")
     //.attr("transform", "translate(" + ((width - cellSize * 53) / 2) + "," + (height - cellSize * 7 - 1) + ")");
     .attr("transform", "translate(" + '-50' + "," + 0 + ")");

     svg_g.append("text")
        .attr("transform", "translate(-6," + cellSize * 3.5 + ")rotate(-90)")
        .attr("font-family", "sans-serif")
        .attr("font-size", 10)
        .attr("text-anchor", "middle")
        .text(function (d) { return d; });

    var rect = svg_g.append("g")
        .attr("fill", "none")
        .selectAll("rect")
        .data(function (d) { return d3.timeDays(new Date(d, 1, 24), new Date()); })
        .enter()
        .append("rect")
        .attr('class', 'day')
        .attr("width", cellSize)
        .attr("height", cellSize)
        .attr("x", function (d) { return d3.timeWeek.count(d3.timeYear(d), d) * cellSize; })
        .attr("y", function (d) { return d.getDay() * cellSize; })
        .attr("stroke", "white")
        .style("opacity", "0.9")
        .on("mouseenter", function(){
                d3.selectAll('.day').style("opacity", 0.9)
                d3.select(this).style("opacity", 1)
            })        
        .datum(d3.timeFormat("%Y-%m-%d"));


    svg_g.append("g")
        .attr("fill", "none")
        .attr("stroke", "#333")
        .attr("stroke-width", "2px")
        .selectAll("path")
        .data(function (d) { return d3.timeMonths(new Date(d, 0, 31), new Date()); })
        .enter()
        .append("path")
        .attr("d", pathMonth);
        
        
    var legend = svg
        .append("g")    
        .attr("transform", "translate(" + '-50' + "," + 0 + ")")    
        .selectAll(".legend")
	    .data(month_data)
	    .enter()
        .append('g')	
        .attr("class", "legend")    
		.attr("transform", function(d, i) { return "translate(" + (((cellSize*4.3)*i)+(width/100)) + ","+ (height-20) +")"; })
        .append("text")
        .attr("x", 0)
        .attr("y", 0)
        .text(function(d){ return d})
        .style('font-size', '14px')
        .style('letter-spacing', '1px');    

    d3.select('#show_all_video')
            .on('click', function(){               
                d3.selectAll('.video-item').style("display", 'block');
                d3.select('#selected-date').html('Обреріть день в календарі:');
                d3.select('#show_all_video').html('Показано всі відео');
                d3.selectAll('.day').attr("stroke", "white");  
    })

    function d3_jsonl(url) {
        return d3.text(url).then(function (text) {
            return text.trim().split('\n').map(JSON.parse);
        });
        }


    d3_jsonl("data/media.jsonl").then(function (video) {

        video.forEach(function (d) {
            d.parced_date = d3.timeParse('%Y-%m-%dT%H:%M:%S+00:00')(d.msg_date)
            d.date = (d.parced_date.getFullYear()).toString() +"-"+ ("0" + (d.parced_date.getMonth() + 1)).slice(-2) + "-"+ ("0" + d.parced_date.getDay()).slice(-2)
           
        })

        console.log(video);


        var items = d3.select("#video-wrapper")
            .selectAll(".video-item")
            .data(video)
            .enter()
            .append("div")
            .attr("class", "video-item");

        var decription = items.append('div')
            .attr('class', 'description')
            .append('p')
            .attr('class', 'tip')
            .html(function (d) {
                return "<span>"+d.source_title + "</span> <br> <span>" + d.date + "</span>"
            })

        var vid = items
            .append("video")            
            .attr("poster", function(d){ return ROOT + d.thumb1_path})
            .attr("preload", "none")
            .attr('controls', "")
            .append('source')
            .attr('src', function (d) { return ROOT + d.file_path })
            .attr('type', 'video/mp4')

        var data = d3.nest()
            .key(function (d) { return d.date; })           
            .entries(video);

        console.log(data)

        rect
            .on('click', function(d){  
                d3.selectAll('.day').attr("stroke", "white")  
                d3.select(this).attr("stroke", "black").attr("stroke-width","2px").raise();
                vid.each(function(t){                    
                    d3.select(this.parentNode.parentNode)
                        .style("display", t.date === d ? "block" : "none")
                })
                d3.select("#selected-date").text('Обрана дата: '+ d)
                d3.select('#show_all_video').html('Прибрати фільтр &times; ')
            })
            .attr('data-tippy-content', function(d){ return d })
            .attr("fill", function (d) { 
                let el = data.filter(function(t){ return t.key === d })
                return el[0] ? color(el[0].values.length) : 'lightgrey'
            })
            .attr("data-fill", function (d) { 
                let el = data.filter(function(t){ return t.key === d})
                return el[0] ? color(el[0].values.length) : 'lightgrey'
            });   
            
            
            tippy('.day', {                 
                allowHTML: true, 
                maxWidth: 350, 
                placement: 'bottom'               
            });


           

    })

    

    function pathMonth(t0) {
        var t1 = new Date(t0.getFullYear(), t0.getMonth() + 1, 0),
            d0 = t0.getDay(), w0 = d3.timeWeek.count(d3.timeYear(t0), t0),
            d1 = t1.getDay(), w1 = d3.timeWeek.count(d3.timeYear(t1), t1);
        return "M" + (w0 + 1) * cellSize + "," + d0 * cellSize
            + "H" + w0 * cellSize + "V" + 7 * cellSize
            + "H" + w1 * cellSize + "V" + (d1 + 1) * cellSize
            + "H" + (w1 + 1) * cellSize + "V" + 0
            + "H" + (w0 + 1) * cellSize + "Z";
    }
</script>

</html>